<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√†i ƒë·∫∑t ESign</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #007AFF, #5856D6);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
        }
        h1 { color: #1d1d1f; margin-bottom: 10px; }
        p { color: #86868b; margin-bottom: 30px; }
        .btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }
        .btn:hover { background: #0056CC; transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .steps { text-align: left; margin-top: 30px; color: #666; font-size: 14px; }
        .step { margin-bottom: 10px; padding-left: 20px; position: relative; }
        .step:before { content: "‚úì"; position: absolute; left: 0; color: #007AFF; }
        .hidden { display: none; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Popup th√¥ng b√°o */
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }
        .popup-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 350px;
            margin: 20px;
            animation: slideUp 0.3s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes slideUp { 
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <div class="logo">üì±</div>
        <h1>C√†i ƒë·∫∑t ESign</h1>
        <p>·ª®ng d·ª•ng ƒë√£ ƒë∆∞·ª£c k√Ω h·ª£p l·ªá, s·∫µn s√†ng c√†i ƒë·∫∑t tr√™n iOS</p>
        <button class="btn" id="installBtn">C√†i ƒë·∫∑t ngay</button>
        
        <div class="steps">
            <div class="step">K√Ω ch·ª©ng ch·ªâ h·ª£p l·ªá</div>
            <div class="step">C√†i ƒë·∫∑t OTA tr·ª±c ti·∫øp</div>
            <div class="step">Tin c·∫≠y nh√† ph√°t tri·ªÉn</div>
        </div>
    </div>

    <div class="container hidden" id="loadingContainer">
        <div class="logo loading">‚è≥</div>
        <h1>ƒêang c√†i ƒë·∫∑t...</h1>
        <p id="statusText">ƒêang k·∫øt n·ªëi v·ªõi m√°y ch·ªß</p>
        <div class="steps">
            <div id="step1">‚úì ƒêang t·∫£i ·ª©ng d·ª•ng...</div>
            <div id="step2">Ch·ªù x√°c nh·∫≠n c√†i ƒë·∫∑t...</div>
            <div id="step3">Ho√†n t·∫•t thi·∫øt l·∫≠p...</div>
        </div>
    </div>

    <script>
        // C·∫§U H√åNH - ƒêI·ªÄU CH·ªàNH THEO FILE IPA TH·∫¨T C·ª¶A B·∫†N
        const CONFIG = {
            // D√ôNG GITHACK.COM CHO T·ªêT H∆†N
            ipaUrl: 'https://rawcdn.githack.com/phnamm-dev/server-resources/refs/heads/main/file/namserver-ESign-signed.ipa',
            
            // BUNDLE ID - L·∫§Y T·ª™ FILE IPA TH·∫¨T
            bundleId: 'nya.asami.ksign', // N·∫øu ƒë√¢y l√† bundle ID th·∫≠t
            
            appName: 'ESign',
            appVersion: '1.0'
        };

        // C√°c ph·∫ßn t·ª≠ DOM
        const mainContainer = document.getElementById('mainContainer');
        const loadingContainer = document.getElementById('loadingContainer');
        const installBtn = document.getElementById('installBtn');
        const statusText = document.getElementById('statusText');
        
        // ========== H√ÄM KI·ªÇM TRA THI·∫æT B·ªä CH√çNH X√ÅC ==========
        function isIOSDevice() {
            const ua = navigator.userAgent.toLowerCase();
            const platform = navigator.platform;
            
            // Ki·ªÉm tra iPad (k·ªÉ c·∫£ iPad Pro v·ªõi macOS-like user agent)
            const isIPad = /ipad/.test(ua) || 
                          (platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            
            // Ki·ªÉm tra iPhone/iPod
            const isIPhone = /iphone/.test(ua);
            const isIPod = /ipod/.test(ua);
            
            // Ki·ªÉm tra th√¥ng qua vendor
            const isAppleDevice = /apple/.test(navigator.vendor.toLowerCase());
            
            console.log('User Agent:', navigator.userAgent);
            console.log('Platform:', platform);
            console.log('Max Touch Points:', navigator.maxTouchPoints);
            console.log('Vendor:', navigator.vendor);
            console.log('isIPad:', isIPad);
            console.log('isIPhone:', isIPhone);
            console.log('isIPod:', isIPod);
            
            return isIPad || isIPhone || isIPod;
        }
        
        // Hi·ªÉn th·ªã popup th√¥ng b√°o
        function showPopup(message, isError = false) {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h3>${isError ? '‚ö†Ô∏è Th√¥ng b√°o' : '‚ÑπÔ∏è Th√¥ng tin'}</h3>
                    <p style="margin: 20px 0; color: #333;">${message}</p>
                    <button class="btn" onclick="this.closest('.popup').remove()">ƒê√£ hi·ªÉu</button>
                </div>
            `;
            document.body.appendChild(popup);
            
            // T·ª± ƒë·ªông ƒë√≥ng sau 5 gi√¢y n·∫øu kh√¥ng ph·∫£i l·ªói
            if (!isError) {
                setTimeout(() => popup.remove(), 5000);
            }
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i
        function updateStatus(text, step = 0) {
            statusText.textContent = text;
            
            const steps = ['step1', 'step2', 'step3'];
            steps.forEach((id, index) => {
                const el = document.getElementById(id);
                if (el) {
                    if (index < step) {
                        el.innerHTML = '‚úì ' + el.textContent.replace(/[‚úì‚è≥] /g, '');
                        el.style.color = '#007AFF';
                    } else if (index === step) {
                        el.innerHTML = '‚è≥ ' + el.textContent.replace(/[‚úì‚è≥] /g, '');
                        el.style.color = '#1d1d1f';
                    } else {
                        el.innerHTML = el.textContent.replace(/[‚úì‚è≥] /g, '');
                        el.style.color = '#86868b';
                    }
                }
            });
        }

        // T·∫°o manifest.plist
        function createManifestPlist() {
            return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>items</key>
    <array>
        <dict>
            <key>assets</key>
            <array>
                <dict>
                    <key>kind</key>
                    <string>software-package</string>
                    <key>url</key>
                    <string>${CONFIG.ipaUrl}</string>
                </dict>
            </array>
            <key>metadata</key>
            <dict>
                <key>bundle-identifier</key>
                <string>${CONFIG.bundleId}</string>
                <key>bundle-version</key>
                    <string>${CONFIG.appVersion}</string>
                <key>kind</key>
                <string>software</string>
                <key>title</key>
                <string>${CONFIG.appName}</string>
            </dict>
        </dict>
    </array>
</dict>
</plist>`;
        }

        // K√≠ch ho·∫°t c√†i ƒë·∫∑t
        async function startInstallation() {
            console.log('B·∫Øt ƒë·∫ßu c√†i ƒë·∫∑t...');
            
            // Ki·ªÉm tra thi·∫øt b·ªã CH√çNH X√ÅC
            const isIOS = isIOSDevice();
            console.log('K·∫øt qu·∫£ ki·ªÉm tra iOS:', isIOS);
            
            if (!isIOS) {
                showPopup(
                    '‚ö†Ô∏è Vui l√≤ng m·ªü trang n√†y tr√™n iPhone ho·∫∑c iPad ƒë·ªÉ c√†i ƒë·∫∑t ·ª©ng d·ª•ng.\n\n' +
                    'N·∫øu b·∫°n ƒëang d√πng iPad m√† v·∫´n th·∫•y th√¥ng b√°o n√†y:\n' +
                    '1. ƒê·∫£m b·∫£o ƒëang d√πng Safari\n' +
                    '2. Th·ª≠ t·∫£i l·∫°i trang\n' +
                    '3. Th·ª≠ m·ªü trong tr√¨nh duy·ªát ·∫©n danh',
                    true
                );
                return;
            }
            
            // Chuy·ªÉn sang m√†n h√¨nh loading
            mainContainer.classList.add('hidden');
            loadingContainer.classList.remove('hidden');
            
            updateStatus('ƒêang ki·ªÉm tra thi·∫øt b·ªã...', 0);
            
            // B∆∞·ªõc 1: T·∫°o manifest
            updateStatus('ƒêang t·∫°o g√≥i c√†i ƒë·∫∑t...', 1);
            await new Promise(resolve => setTimeout(resolve, 800));
            
            try {
                // T·∫°o manifest URL
                const manifestContent = createManifestPlist();
                const manifestBlob = new Blob([manifestContent], { type: 'application/x-plist' });
                const manifestUrl = URL.createObjectURL(manifestBlob);
                
                console.log('Manifest URL created:', manifestUrl);
                
                // B∆∞·ªõc 2: K√≠ch ho·∫°t c√†i ƒë·∫∑t
                updateStatus('M·ªü tr√¨nh c√†i ƒë·∫∑t iOS...', 2);
                
                // Ph∆∞∆°ng ph√°p 1: D√πng location.href (ƒë∆°n gi·∫£n nh·∫•t)
                const installUrl = `itms-services://?action=download-manifest&url=${encodeURIComponent(manifestUrl)}`;
                console.log('Install URL:', installUrl);
                
                // Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n tr∆∞·ªõc
                showPopup(
                    'üì≤ ƒêang m·ªü tr√¨nh c√†i ƒë·∫∑t iOS...\n\n' +
                    'N·∫øu kh√¥ng th·∫•y popup c√†i ƒë·∫∑t:\n' +
                    '1. Cho ph√©p popup trong Safari Settings\n' +
                    '2. Nh·∫•n v√†o thanh ƒë·ªãa ch·ªâ v√† ch·ªçn "M·ªü"\n' +
                    '3. Ho·∫∑c nh·∫•n gi·ªØ li√™n k·∫øt d∆∞·ªõi ƒë√¢y v√† ch·ªçn "M·ªü"',
                    false
                );
                
                // T·∫°o link ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫•n n·∫øu t·ª± ƒë·ªông th·∫•t b·∫°i
                const manualLink = document.createElement('a');
                manualLink.href = installUrl;
                manualLink.textContent = 'Nh·∫•n v√†o ƒë√¢y n·∫øu kh√¥ng t·ª± ƒë·ªông chuy·ªÉn';
                manualLink.style.display = 'block';
                manualLink.style.margin = '20px 0';
                manualLink.style.padding = '15px';
                manualLink.style.background = '#007AFF';
                manualLink.style.color = 'white';
                manualLink.style.borderRadius = '10px';
                manualLink.style.textDecoration = 'none';
                loadingContainer.appendChild(manualLink);
                
                // Th·ª≠ chuy·ªÉn h∆∞·ªõng t·ª± ƒë·ªông
                setTimeout(() => {
                    window.location.href = installUrl;
                }, 1500);
                
                // Ph∆∞∆°ng ph√°p 2: D√πng iframe (d·ª± ph√≤ng)
                setTimeout(() => {
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = installUrl;
                    document.body.appendChild(iframe);
                    
                    setTimeout(() => {
                        iframe.remove();
                        URL.revokeObjectURL(manifestUrl);
                    }, 5000);
                }, 2000);
                
                // B∆∞·ªõc 3: Ho√†n t·∫•t
                updateStatus('Ch·ªù x√°c nh·∫≠n c√†i ƒë·∫∑t...', 3);
                
                // H∆∞·ªõng d·∫´n sau c√†i ƒë·∫∑t
                setTimeout(() => {
                    showPopup(
                        '‚úÖ C√†i ƒë·∫∑t ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t!\n\n' +
                        'Sau khi ·ª©ng d·ª•ng xu·∫•t hi·ªán tr√™n m√†n h√¨nh:\n' +
                        '1. V√†o C√†i ƒë·∫∑t > Chung\n' +
                        '2. Ch·ªçn "VPN & Qu·∫£n l√Ω thi·∫øt b·ªã"\n' +
                        '3. T√¨m v√† "Tin c·∫≠y" nh√† ph√°t tri·ªÉn\n\n' +
                        'N·∫øu g·∫∑p l·ªói "ch·ª©ng ch·ªâ kh√¥ng h·ª£p l·ªá", ch·ª©ng ch·ªâ c√≥ th·ªÉ ƒë√£ h·∫øt h·∫°n.',
                        false
                    );
                }, 3000);
                
            } catch (error) {
                console.error('L·ªói c√†i ƒë·∫∑t:', error);
                updateStatus('L·ªói: ' + error.message, 0);
                showPopup('‚ùå L·ªói khi c√†i ƒë·∫∑t: ' + error.message, true);
            }
        }

        // S·ª± ki·ªán click
        installBtn.addEventListener('click', startInstallation);
        
        // Hi·ªÉn th·ªã th√¥ng tin thi·∫øt b·ªã khi trang load
        window.addEventListener('load', () => {
            console.log('=== TH√îNG TIN THI·∫æT B·ªä ===');
            console.log('User Agent:', navigator.userAgent);
            console.log('Platform:', navigator.platform);
            console.log('Vendor:', navigator.vendor);
            console.log('Max Touch Points:', navigator.maxTouchPoints);
            console.log('isIOSDevice:', isIOSDevice());
            console.log('=========================');
            
            // Hi·ªÉn th·ªã th√¥ng tin cho ng∆∞·ªùi d√πng
            const deviceInfo = isIOSDevice() ? 
                'üì± ƒê√£ nh·∫≠n di·ªán thi·∫øt b·ªã iOS/iPadOS' : 
                '‚ö†Ô∏è Kh√¥ng ph·∫£i thi·∫øt b·ªã iOS';
            
            const infoEl = document.createElement('p');
            infoEl.textContent = deviceInfo;
            infoEl.style.fontSize = '12px';
            infoEl.style.color = '#666';
            infoEl.style.marginTop = '10px';
            mainContainer.appendChild(infoEl);
        });
    </script>
</body>
</html>
